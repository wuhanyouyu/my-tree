<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D 手势粒子圣诞树 | Xmas Interactive</title>
    
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424515/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <style>
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: -apple-system, sans-serif; }
        #container { width: 100vw; height: 100vh; }
        
        /* UI 叠加层 */
        #gui { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 30px; box-sizing: border-box; z-index: 100;
        }

        .status-panel {
            background: rgba(184, 134, 11, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.4);
            padding: 15px 25px; border-radius: 12px; width: fit-content;
            backdrop-filter: blur(15px); pointer-events: auto;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        #upload-trigger {
            background: linear-gradient(135deg, #8b0000 0%, #b22222 100%);
            color: #ffd700; padding: 18px 40px; border-radius: 50px;
            border: 2px solid #ffd700; cursor: pointer; pointer-events: auto;
            font-weight: bold; font-size: 16px; letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            align-self: center; box-shadow: 0 10px 25px rgba(139, 0, 0, 0.4);
        }

        #upload-trigger:hover { transform: scale(1.05); box-shadow: 0 15px 35px #ffd70044; }

        #v-stream {
            position: absolute; right: 25px; top: 25px;
            width: 140px; height: 105px; border: 2px solid #b8860b;
            transform: scaleX(-1); background: #111; border-radius: 10px;
            opacity: 0.6; object-fit: cover;
        }

        .instructions { font-size: 13px; opacity: 0.8; text-align: center; line-height: 1.8; text-shadow: 0 2px 4px #000; }
    </style>
</head>
<body>

    <div id="container"></div>

    <div id="gui">
        <div class="status-panel" id="msg" onclick="toggleMode()">✨ 系统准备中...</div>
        
        <label id="upload-trigger" for="file-up">上传你的独家记忆</label>
        <input type="file" id="file-up" style="display:none" accept="image/*" multiple>

        <div class="instructions">
            手势控制：握拳（圣诞树归位） | 五指（星尘炸裂） | 移动手（旋转视界）<br>
            提示：若识别较慢，可直接点击“状态栏”或“屏幕”进行切换
        </div>
    </div>

    <video id="v-stream" autoplay playsinline></video>

    <script>
        /**
         * 3D 系统核心
         */
        let scene, camera, renderer, composer, particles = [];
        let curState = 'CLOSE'; // CLOSE (圣诞树), OPEN (散开)
        const PALETTE = { leaf: 0x1a472a, gold: 0xffd700, red: 0x990000 };

        function initApp() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.04);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 9);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('container').appendChild(renderer.domElement);

            // 电影级 UnrealBloom 后期处理
            const renderPass = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight), 
                1.4, 0.45
