<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D æ‰‹åŠ¿ç²’å­åœ£è¯æ ‘ | Xmas Interactive</title>
    
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424515/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <style>
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: -apple-system, sans-serif; }
        #container { width: 100vw; height: 100vh; }
        
        /* UI å åŠ å±‚ */
        #gui { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 30px; box-sizing: border-box; z-index: 100;
        }

        .status-panel {
            background: rgba(184, 134, 11, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.4);
            padding: 15px 25px; border-radius: 12px; width: fit-content;
            backdrop-filter: blur(15px); pointer-events: auto;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        #upload-trigger {
            background: linear-gradient(135deg, #8b0000 0%, #b22222 100%);
            color: #ffd700; padding: 18px 40px; border-radius: 50px;
            border: 2px solid #ffd700; cursor: pointer; pointer-events: auto;
            font-weight: bold; font-size: 16px; letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            align-self: center; box-shadow: 0 10px 25px rgba(139, 0, 0, 0.4);
        }

        #upload-trigger:hover { transform: scale(1.05); box-shadow: 0 15px 35px #ffd70044; }

        #v-stream {
            position: absolute; right: 25px; top: 25px;
            width: 140px; height: 105px; border: 2px solid #b8860b;
            transform: scaleX(-1); background: #111; border-radius: 10px;
            opacity: 0.6; object-fit: cover;
        }

        .instructions { font-size: 13px; opacity: 0.8; text-align: center; line-height: 1.8; text-shadow: 0 2px 4px #000; }
    </style>
</head>
<body>

    <div id="container"></div>

    <div id="gui">
        <div class="status-panel" id="msg" onclick="toggleMode()">âœ¨ ç³»ç»Ÿå‡†å¤‡ä¸­...</div>
        
        <label id="upload-trigger" for="file-up">ä¸Šä¼ ä½ çš„ç‹¬å®¶è®°å¿†</label>
        <input type="file" id="file-up" style="display:none" accept="image/*" multiple>

        <div class="instructions">
            æ‰‹åŠ¿æ§åˆ¶ï¼šæ¡æ‹³ï¼ˆåœ£è¯æ ‘å½’ä½ï¼‰ | äº”æŒ‡ï¼ˆæ˜Ÿå°˜ç‚¸è£‚ï¼‰ | ç§»åŠ¨æ‰‹ï¼ˆæ—‹è½¬è§†ç•Œï¼‰<br>
            æç¤ºï¼šè‹¥è¯†åˆ«è¾ƒæ…¢ï¼Œå¯ç›´æ¥ç‚¹å‡»â€œçŠ¶æ€æ â€æˆ–â€œå±å¹•â€è¿›è¡Œåˆ‡æ¢
        </div>
    </div>

    <video id="v-stream" autoplay playsinline></video>

    <script>
        /**
         * 3D ç³»ç»Ÿæ ¸å¿ƒ
         */
        let scene, camera, renderer, composer, particles = [];
        let curState = 'CLOSE'; // CLOSE (åœ£è¯æ ‘), OPEN (æ•£å¼€)
        const PALETTE = { leaf: 0x1a472a, gold: 0xffd700, red: 0x990000 };

        function initApp() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.04);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 9);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('container').appendChild(renderer.domElement);

            // ç”µå½±çº§ UnrealBloom åæœŸå¤„ç†
            const renderPass = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight), 
                1.4, 0.45, 0.8
            );
            bloomPass.threshold = 0.2; 
            bloomPass.strength = 1.4;

            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            // å…‰ç…§
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.PointLight(0xffd700, 2.5, 50);
            sun.position.set(5, 10, 5);
            scene.add(sun);

            createForest();
            
            // ç‚¹å‡»äº¤äº’å¤‡ç”¨
            document.getElementById('container').addEventListener('click', toggleMode);

            // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            tick();
        }

        function createForest() {
            const count = 220; // ç²’å­æ•°é‡
            for (let i = 0; i < count; i++) {
                const isSphere = Math.random() > 0.4;
                const geo = isSphere ? new THREE.SphereGeometry(0.12, 10, 10) : new THREE.BoxGeometry(0.16, 0.16, 0.16);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: i % 3 === 0 ? PALETTE.gold : (i % 3 === 1 ? PALETTE.red : PALETTE.leaf),
                    metalness: 0.9, roughness: 0.1 
                });
                const mesh = new THREE.Mesh(geo, mat);

                // è®¡ç®—åœ£è¯æ ‘åœ†é”¥åæ ‡
                const h = Math.random() * 7;
                const r = (h / 7) * 2.8;
                const angle = Math.random() * Math.PI * 2;
                
                mesh.userData.closePos = new THREE.Vector3(Math.cos(angle)*r, h - 3.5, Math.sin(angle)*r);
                mesh.userData.openPos = new THREE.Vector3((Math.random()-0.5)*15, (Math.random()-0.5)*15, (Math.random()-0.5)*15);
                
                mesh.position.copy(mesh.userData.closePos);
                mesh.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);
                
                particles.push(mesh);
                scene.add(mesh);
            }
        }

        /**
         * MediaPipe AI é€»è¾‘
         */
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424515/${file}`
        });

        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
        hands.onResults(onResults);

        function onResults(res) {
            if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) return;
            document.getElementById('msg').innerText = "ğŸ–ï¸ AI å®æ—¶ç›‘æµ‹ä¸­...";
            
            const lm = res.multiHandLandmarks[0];
            // æ¡æ‹³è¯†åˆ«
            const isFist = lm[8].y > lm[6].y && lm[12].y > lm[10].y && lm[16].y > lm[14].y;
            // å¼ æ‰‹è¯†åˆ«
            const isOpen = lm[8].y < lm[5].y && lm[12].y < lm[9].y && lm[20].y < lm[17].y;

            if (isFist) switchState('CLOSE');
            else if (isOpen) switchState('OPEN');

            // è”åŠ¨ç›¸æœºæ—‹è½¬ (å¢åŠ å¹³æ»‘æ’å€¼é˜²æ­¢ç›¸æœºä¸¢å¤±)
            if (curState === 'OPEN') {
                const targetX = (lm[9].x - 0.5) * 18;
                const targetY = -(lm[9].y - 0.5) * 12;
                camera.position.x += (targetX - camera.position.x) * 0.05;
                camera.position.y += (targetY - camera.position.y) * 0.05;
                camera.lookAt(0, 0, 0);
            }
        }

        function switchState(state) {
            if (curState === state) return;
            curState = state;
            document.getElementById('msg').innerText = `å½“å‰çŠ¶æ€: ${state === 'CLOSE' ? 'åœ£è¯æ ‘æ”¶æ‹¢' : 'æ˜Ÿå°˜ç‚¸è£‚'}`;
            
            particles.forEach(p => {
                const dest = state === 'CLOSE' ? p.userData.closePos : p.userData.openPos;
                gsap.to(p.position, { x: dest.x, y: dest.y, z: dest.z, duration: 1.6, ease: "expo.out" });
                gsap.to(p.rotation, { x: Math.random()*10, y: Math.random()*10, duration: 1.6 });
            });

            if (state === 'CLOSE') {
                gsap.to(camera.position, { x: 0, y: 2, z: 9, duration: 1.6, ease: "power2.inOut" });
            }
        }

        function toggleMode() {
            switchState(curState === 'CLOSE' ? 'OPEN' : 'CLOSE');
        }

        // å¯åŠ¨ç¡¬ä»¶
        const video = document.getElementById('v-stream');
        const cam = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 480, height: 360
        });
        cam.start().catch(() => { document.getElementById('msg').innerText = "âš ï¸ éœ€å¼€å¯æ‘„åƒå¤´æƒé™æ‰èƒ½æ‰‹åŠ¿æ§"; });

        // ç…§ç‰‡äº‘åŠŸèƒ½
        document.getElementById('file-up').addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => {
                const url = URL.createObjectURL(file);
                new THREE.TextureLoader().load(url, (tex) => {
                    const plane = new THREE.Mesh(
                        new THREE.PlaneGeometry(1.6, 1.6), 
                        new THREE.MeshBasicMaterial({ map: tex, side: 2, transparent: true })
                    );
                    plane.userData.closePos = new THREE.Vector3((Math.random()-0.5)*3.5, Math.random()*5-2.5, (Math.random()-0.5)*3.5);
                    plane.userData.openPos = new THREE.Vector3((Math.random()-0.5)*14, (Math.random()-0.5)*14, (Math.random()-0.5)*14);
                    plane.position.copy(plane.userData.closePos);
                    particles.push(plane); scene.add(plane);
                });
            });
        });

        function tick() {
            requestAnimationFrame(tick);
            if(curState === 'CLOSE') scene.rotation.y += 0.006;
            composer.render();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        initApp();
    </script>
</body>
</html>
