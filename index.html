<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesture Xmas Tree | 3D 手势交互系统</title>
    
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <style>
        body { margin: 0; background: #050505; color: white; overflow: hidden; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; }
        
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }

        .badge {
            background: rgba(184, 134, 11, 0.2);
            border: 1px solid #b8860b;
            padding: 12px; border-radius: 4px; width: fit-content;
            backdrop-filter: blur(5px);
        }

        #upload-btn {
            background: #8b0000; color: #ffd700;
            padding: 15px 30px; border-radius: 50px;
            border: 2px solid #ffd700; cursor: pointer;
            pointer-events: auto; font-weight: bold;
            transition: 0.3s; align-self: center;
        }

        #video-preview {
            position: absolute; right: 20px; top: 20px;
            width: 120px; height: 90px;
            border: 1px solid #555; transform: scaleX(-1);
            background: #222; border-radius: 8px;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="badge" id="status">正在启动 3D 引擎与 AI...</div>
        
        <label id="upload-btn" for="file-input">点击上传照片记忆</label>
        <input type="file" id="file-input" style="display:none" accept="image/*" multiple>

        <div style="font-size: 12px; opacity: 0.6; text-align: center;">
            握拳：聚合 | 五指：散开 | 捏合：放大照片 | 移动手：旋转场景
        </div>
    </div>

    <video id="video-preview" autoplay playsinline></video>

    <script>
        /**
         * 3D 系统配置
         */
        let scene, camera, renderer, composer, elements = [];
        let currentState = 'CLOSE';
        const COLORS = { green: 0x1a3300, gold: 0xffd700, red: 0x8b0000 };

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 8);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 电影级辉光
            const renderPass = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.2; bloomPass.strength = 1.2;
            
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const pLight = new THREE.PointLight(0xffd700, 2);
            pLight.position.set(5, 5, 5);
            scene.add(pLight);

            createElements();
            animate();
        }

        function createElements() {
            for (let i = 0; i < 150; i++) {
                const geo = Math.random() > 0.5 ? new THREE.SphereGeometry(0.12, 12, 12) : new THREE.BoxGeometry(0.15, 0.15, 0.15);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: i % 3 === 0 ? COLORS.gold : (i % 3 === 1 ? COLORS.red : COLORS.green),
                    metalness: 0.7, roughness: 0.2 
                });
                const mesh = new THREE.Mesh(geo, mat);

                // 算法生成圣诞树圆锥坐标
                const h = Math.random() * 6;
                const r = (h / 6) * 2.5;
                const angle = Math.random() * Math.PI * 2;
                mesh.userData.closePos = new THREE.Vector3(Math.cos(angle)*r, h - 3, Math.sin(angle)*r);
                mesh.userData.scatterPos = new THREE.Vector3((Math.random()-0.5)*12, (Math.random()-0.5)*12, (Math.random()-0.5)*12);
                
                mesh.position.copy(mesh.userData.closePos);
                elements.push(mesh);
                scene.add(mesh);
            }
        }

        /**
         * 手势识别系统
         */
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
        hands.onResults(onHandResults);

        function onHandResults(res) {
            if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) return;
            document.getElementById('status').innerText = "AI 识别中...";
            
            const lm = res.multiHandLandmarks[0];
            const isFist = lm[8].y > lm[6].y && lm[12].y > lm[10].y;
            const isOpen = lm[8].y < lm[6].y && lm[12].y < lm[10].y && lm[4].y < lm[2].y;

            if (isFist) switchState('CLOSE');
            else if (isOpen) switchState('SCATTER');

            if (currentState === 'SCATTER') {
                camera.position.x += ((lm[9].x - 0.5) * 15 - camera.position.x) * 0.05;
                camera.position.y += (-(lm[9].y - 0.5) * 10 - camera.position.y) * 0.05;
                camera.lookAt(0, 0, 0);
            }
        }

        function switchState(state) {
            if (currentState === state) return;
            currentState = state;
            document.getElementById('status').innerText = `当前状态: ${state === 'CLOSE' ? '圣诞树' : '星尘散开'}`;
            
            elements.forEach(el => {
                const target = state === 'CLOSE' ? el.userData.closePos : el.userData.scatterPos;
                gsap.to(el.position, { x: target.x, y: target.y, z: target.z, duration: 1.5, ease: "expo.out" });
            });
        }

        // 启动摄像头
        const video = document.getElementById('video-preview');
        const cam = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 480, height: 360
        });
        cam.start().catch(() => { document.getElementById('status').innerText = "错误: 请允许开启摄像头"; });

        // 图片上传逻辑
        document.getElementById('file-input').addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => {
                const url = URL.createObjectURL(file);
                const tex = new THREE.TextureLoader().load(url);
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(1.2, 1.2), new THREE.MeshBasicMaterial({ map: tex, side: 2 }));
                mesh.userData.closePos = new THREE.Vector3((Math.random()-0.5)*2, Math.random()*4-2, (Math.random()-0.5)*2);
                mesh.userData.scatterPos = new THREE.Vector3((Math.random()-0.5)*10, (Math.random()-0.5)*10, (Math.random()-0.5)*10);
                mesh.position.copy(mesh.userData.closePos);
                elements.push(mesh); scene.add(mesh);
            });
        });

        function animate() {
            requestAnimationFrame(animate);
            if(currentState === 'CLOSE') scene.rotation.y += 0.005;
            composer.render();
        }

        init();
    </script>
</body>
</html>
